pipeline {

  agent any
  
    tools {
        go 'go'
    }
    environment {
        CREDENTIALS_ID  = "GENESYSCLOUD_OAUTHCLIENT_ID_AND_SECRET" 
        GOPATH = "${JENKINS_HOME}/jobs/${JOB_NAME}/builds/${BUILD_ID}"
		TF_ACC = "1"
        TF_LOG = "DEBUG"
        TF_LOG_PATH = "../test.log"
		GENESYSCLOUD_REGION = "us-east-1"
        GENESYSCLOUD_SDK_DEBUG =  "true"
        GENESYSCLOUD_TOKEN_POOL_SIZE =  20
    }
      
  stages {
        /*
        stage('Install Dependencies & Build') {
            steps {
                echo 'Installing dependencies'
                sh 'go version'
                sh 'go mod download'
                sh 'go build -v .'
            }
	    }*/

        stage('Terraform Check') {
            steps {
                echo 'Check Terraform Installation'
                sh 'terraform -version'

            }
        }
        /*
        stage('Tests') {
            steps {
            
                catchError(buildResult: 'SUCCESS', stageResult:'FAILURE'){
                    echo 'Attempting to Run Tests'
                    withCredentials([usernamePassword(credentialsId: CREDENTIALS_ID, usernameVariable: 'GENESYSCLOUD_OAUTHCLIENT_ID',passwordVariable:'GENESYSCLOUD_OAUTHCLIENT_SECRET')])
                        {
                            echo 'Loading Genesys OAuth Credentials'
                            sh 'go test -timeout 80m -v -cover ./genesyscloud/... -parallel 10 -coverprofile=coverage.out'
                            
                        }

                }

            }
        } */

        stage('Generate Readable Coverage Report') {
            steps {
                sh 'go tool cover -html coverage.out -o cover.html'

            }
        }

        stage('Archive artifacts') {
            steps {
                archiveArtifacts artifacts: 'cover.html', onlyIfSuccessful: true

            }
        }

    } 

}